window.addEventListener("load",(()=>{const e=document.querySelector(".builder"),t=e.querySelector(".upload"),s=e.querySelector(".download"),i=e.querySelector(".inner"),a=i.querySelector(".layers");let l=i.querySelector(".canvas");function n(){document.body.style.setProperty("--h",window.innerHeight+"px");const e=l.getBoundingClientRect();a.style.width=e.width+"px",a.style.height=e.height+"px"}function o(e){const o=e.width,r=e.height;function c(){const t=e.getBoundingClientRect(),i=o/t.width,l=r/t.height,n=document.createElement("canvas");n.width=o,n.height=r;const c=n.getContext("2d");c.drawImage(e,0,0);for(const e of a.children){const t=e.querySelector("img"),s=parseFloat(e.style.left)*i||0,a=parseFloat(e.style.top)*l||0,n=t.width*i,o=t.height*l,r=e.classList.contains("flipped");+e.dataset.rotate?(c.save(),c.translate(s+n/2,a+o/2),c.rotate(+e.dataset.rotate),c.translate(-s-n/2,-a-o/2),r?(c.scale(-1,1),c.drawImage(t,-1*s-n,a,n,o)):c.drawImage(t,s,a,n,o),c.restore()):r?(c.save(),c.scale(-1,1),c.drawImage(t,-1*s-n,a,n,o),c.restore()):c.drawImage(t,s,a,n,o)}n.toBlob((e=>{s.href=URL.createObjectURL(e),s.click()}),"image/jpeg")}let d;function g(){d&&d.element.classList.remove("selected")}function m(e){return e.changedTouches?e.changedTouches[0]:e}e.className="canvas",l.parentElement.replaceChild(e,l),l=e,t.style.display="none",a.innerHTML="",i.style.display="block",n(),i.onmousedown=i.ontouchstart=e=>{if(e.target.classList.contains("flip"))d.element.classList.toggle("flipped");else if(e.target.classList.contains("remove"))d.element.remove(),d=void 0;else if(e.target.classList.contains("rotate")){const t=d.element.getBoundingClientRect(),s=t.width/2;d.rotate={x:t.x+s,y:t.y+s,left:e.target.classList.contains("left")}}else if(e.target.classList.contains("resize")){const t=d.element.getBoundingClientRect();d.resize={top:e.target.classList.contains("top"),left:e.target.classList.contains("left"),x:t.x,y:t.y,size:t.width}}else e.target.classList.contains("layer-t")?function(e,t){g(),t.classList.add("selected");const s=m(e),i=t.getBoundingClientRect();d={element:t,x:s.clientX-i.x,y:s.clientY-i.y,drag:!0}}(e,e.target.parentElement):d&&(g(),d=void 0)},i.onmouseup=i.ontouchend=i.onmouseleave=()=>{d&&(d.drag=void 0,d.resize=void 0,d.rotate=void 0)},i.onmousemove=i.ontouchmove=e=>{if(e=m(e),d?.drag){const t=d.element,s=t.parentElement.getBoundingClientRect();t.style.top=e.clientY-s.y-d.y+"px",t.style.left=e.clientX-s.x-d.x+"px"}else if(d?.resize){let{clientX:t,clientY:s}=e;const i=d.resize.size,a=+d.element.dataset.rotate;if(a){const l=d.resize.x+i/2,n=d.resize.y+i/2,o=e.clientX-l,r=e.clientY-n,c=2*Math.PI-a;t=o*Math.cos(c)-r*Math.sin(c)+l,s=o*Math.sin(c)+r*Math.cos(c)+n}const l=d.resize.left?d.resize.x-t+i:t-d.resize.x,n=d.resize.top?d.resize.y-s+i:s-d.resize.y,o=Math.max(64,Math.min(l,n)),r=o-i;d.resize.top&&(d.element.style.top=parseFloat(d.element.style.top)-r+"px",d.resize.y-=r),d.resize.left&&(d.element.style.left=parseFloat(d.element.style.left)-r+"px",d.resize.x-=r),d.element.style.width=o+"px",d.resize.size=o}else if(d?.rotate){const t=(d.rotate.left?Math.PI:0)+Math.atan2(e.clientY-d.rotate.y,e.clientX-d.rotate.x);d.element.dataset.rotate=t,d.element.firstElementChild.style.transform=`rotate(${180*t/Math.PI}deg)`}},i.querySelector(".tools").onclick=e=>{if(e.target instanceof Image){const t=document.createElement("div");t.innerHTML=`<div class="layer-t"><img src="${e.target.src}" /><div class="resize top left"></div><div class="resize bottom left"></div><div class="resize top right"></div><div class="resize bottom right"></div><div class="action flip"><img src="images/builder/flip.svg" /></div><div class="action remove"><img src="images/builder/remove.svg" /></div><div class="action rotate left"><img src="images/builder/rotate-left.svg" /></div><div class="action rotate right"><img src="images/builder/rotate-right.svg" /></div></div>`,t.dataset.size=200,t.style.width="200px",t.className="layer selected",a.appendChild(t),d={element:t}}},i.querySelector(".save").onclick=c,document.onkeydown=e=>{e.ctrlKey&&"s"===e.key&&(e.preventDefault(),c())}}t.addEventListener("change",(()=>{if(1===t.files.length){const e=new FileReader;e.onload=()=>{const t=new Image;t.onload=()=>o(t),t.src=e.result},e.readAsDataURL(t.files[0])}})),e.querySelector(".upload-wrapper").onclick=()=>t.click(),i.querySelector(".reupload").onclick=()=>t.click(),window.addEventListener("resize",n)}));