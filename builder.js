window.addEventListener("load",(()=>{const e=document.querySelector(".builder"),t=e.querySelector(".upload"),s=e.querySelector(".inner"),i=s.querySelector(".layers");let l=s.querySelector(".canvas");function n(){const e=l.getBoundingClientRect();i.style.width=e.width+"px",i.style.height=e.height+"px"}function a(e){const a=e.width,o=e.height;function r(){const t=e.getBoundingClientRect(),s=a/t.width,l=o/t.height,n=document.createElement("canvas");n.width=a,n.height=o;const r=n.getContext("2d");r.drawImage(e,0,0);for(const e of i.children){const t=e.querySelector("img"),i=parseFloat(e.style.left)*s||0,n=parseFloat(e.style.top)*l||0,a=t.width*s,o=t.height*l,c=e.classList.contains("flipped");+e.dataset.rotate?(r.save(),r.translate(i+a/2,n+o/2),r.rotate(+e.dataset.rotate),r.translate(-i-a/2,-n-o/2),c?(r.scale(-1,1),r.drawImage(t,-1*i-a,n,a,o)):r.drawImage(t,i,n,a,o),r.restore()):c?(r.save(),r.scale(-1,1),r.drawImage(t,-1*i-a,n,a,o),r.restore()):r.drawImage(t,i,n,a,o)}n.toBlob((e=>{const t=URL.createObjectURL(e);window.open(t)}),"image/jpeg")}let c;function d(){c&&c.element.classList.remove("selected")}function g(e){return e.changedTouches?e.changedTouches[0]:e}e.className="canvas",l.parentElement.replaceChild(e,l),l=e,t.style.display="none",i.innerHTML="",s.style.display="block",n(),s.onmousedown=s.ontouchstart=e=>{if(e.target.classList.contains("flip"))c.element.classList.toggle("flipped");else if(e.target.classList.contains("remove"))c.element.remove(),c=void 0;else if(e.target.classList.contains("rotate")){const t=c.element.getBoundingClientRect(),s=t.width/2;c.rotate={x:t.x+s,y:t.y+s,left:e.target.classList.contains("left")}}else if(e.target.classList.contains("resize")){const t=c.element.getBoundingClientRect();c.resize={top:e.target.classList.contains("top"),left:e.target.classList.contains("left"),x:t.x,y:t.y,size:t.width}}else e.target.classList.contains("layer-t")?function(e,t){d(),t.classList.add("selected");const s=g(e),i=t.getBoundingClientRect();c={element:t,x:s.clientX-i.x,y:s.clientY-i.y,drag:!0}}(e,e.target.parentElement):c&&(d(),c=void 0)},s.onmouseup=s.ontouchend=s.onmouseleave=()=>{c&&(c.drag=void 0,c.resize=void 0,c.rotate=void 0)},s.onmousemove=s.ontouchmove=e=>{if(e=g(e),c?.drag){const t=c.element,s=t.parentElement.getBoundingClientRect();t.style.top=e.clientY-s.y-c.y+"px",t.style.left=e.clientX-s.x-c.x+"px"}else if(c?.resize){const t=c.resize.size,s=c.resize.left?c.resize.x-e.clientX+t:e.clientX-c.resize.x,i=c.resize.top?c.resize.y-e.clientY+t:e.clientY-c.resize.y,l=Math.max(64,Math.min(s,i)),n=l-t;c.resize.top&&(c.element.style.top=parseFloat(c.element.style.top)-n+"px",c.resize.y-=n),c.resize.left&&(c.element.style.left=parseFloat(c.element.style.left)-n+"px",c.resize.x-=n),c.element.style.width=l+"px",c.resize.size=l}else if(c?.rotate){const t=(c.rotate.left?Math.PI:0)+Math.atan2(e.clientY-c.rotate.y,e.clientX-c.rotate.x);c.element.dataset.rotate=t,c.element.firstElementChild.style.transform=`rotate(${180*t/Math.PI}deg)`}},s.querySelector(".tools").onclick=e=>{if(e.target instanceof Image){const t=document.createElement("div");t.innerHTML=`<div class="layer-t"><img src="${e.target.src}" /><div class="resize top left"></div><div class="resize bottom left"></div><div class="resize top right"></div><div class="resize bottom right"></div><div class="action flip"><img src="images/builder/flip.svg" /></div><div class="action remove"><img src="images/builder/remove.svg" /></div><div class="action rotate left"><img src="images/builder/rotate-left.svg" /></div><div class="action rotate right"><img src="images/builder/rotate-right.svg" /></div></div>`,t.dataset.size=200,t.style.width="200px",t.className="layer selected",i.appendChild(t),c={element:t}}},s.querySelector(".save").onclick=r,document.onkeydown=e=>{e.ctrlKey&&"s"===e.key&&(e.preventDefault(),r())}}t.addEventListener("change",(()=>{if(1===t.files.length){const e=new FileReader;e.onload=()=>{const t=new Image;t.onload=()=>a(t),t.src=e.result},e.readAsDataURL(t.files[0])}})),e.querySelector(".upload-wrapper").onclick=()=>t.click(),s.querySelector(".reupload").onclick=()=>t.click(),window.addEventListener("resize",n)}));